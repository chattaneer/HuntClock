<!doctype html>
<html lang="en">
  <head>
    <title>HuntScore</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ" crossorigin="anonymous"></script>
    -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <script src="js/jquery.js"></script>
    <script src="js/popper.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/getMoonPhase.js"></script>
  </head>
  <body>

    <nav class="navbar navbar-expand-md navbar-dark bg-dark mb-4">
      <a class="navbar-brand" href="#">HuntScore</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav mr-auto">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="http://example.com" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              Resources
            </a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
              <a class="dropdown-item" href="http://www.mossyoak.com/our-obsession/blogs/cuzs-corner/2012/11/20/20-years-of-deer-research-on-deer-movement">Weather</a>
              <a class="dropdown-item" href="https://www.outdoorlife.com/blogs/big-buck-zone/2011/09/seven-things-know-about-temperature-and-deer-activity">Temperature</a>
              <a class="dropdown-item" href="https://www.outdoorlife.com/blogs/big-buck-zone/2011/10/how-barometric-pressure-affects-deer">Air Pressure</a>
              <a class="dropdown-item" href="http://www.mossyoak.com/our-obsession/blogs/cuzs-corner/2012/11/20/the-effect-moon-phase-has-on-hunting-deer">Moon Phase</a>
            </div>
          </li>
        </ul>
      </div>
    </nav>

    <main role="main" class="container">
      
      <div class="jumbotron" id="welcome-message">
        <h1>Getting Started</h1>
        <p class="lead">This website is very easy to use. Simply enter your zip code below and click "Go!" The results will contain the current conditions and forecasts every 3 hours. Each forecast is given a score between 0 and 100 based on temperature, wind, pressure, and cloud cover. The better the score, the better the hunt.</p>
      </div>
      
      <div class="container-fluid">
        <div class="input-group">
          <span class="input-group-addon" id="basic-addon3">Zip Code</span>
          <input type="text" class="form-control" id="zip-code" aria-describedby="basic-addon3">
          <span class="input-group-btn">
            <button class="btn btn-secondary" type="button" id="go">Go!</button>
          </span>
        </div>
      </div>
      
    </main>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script>
      $(document).ready(function() {
        if(window.navigator.geolocation) {
          window.navigator.geolocation.getCurrentPosition(function(pos) {
            $.get('https://maps.googleapis.com/maps/api/geocode/json?latlng=' + pos.coords.latitude + ',' + pos.coords.longitude + '&sensor=true', function(data, status){
              $('#zip-code').val(data.results[0].address_components[7].long_name);
            });
          });
        }
      });

      $("#zip-code").keyup(function(event) {
          if (event.keyCode === 13) {
              $("#go").click();
          }
      });

      $("#go").click(function(){
        $('#welcome-message').remove();
        // current data
        var url_weather = "https://api.openweathermap.org/data/2.5/weather?zip=" + $('#zip-code').val() + "&appid=c2abeae755e331ef388663568b1d5ae1&units=imperial";
        $.getJSON(url_weather, function(data) {
          console.log(data);
          var date = new Date(data.dt*1000);
          var temp = data.main.temp;
          var pressure = Math.round((data.main.pressure)*0.02953*100)/100;
          var wind = data.wind.speed;
          var cloud = data.clouds.all;
          
          var wind_score = wind *100 / 10;
          if(wind_score > 100)
            wind_score = 100;
          
          var pressure_score = 0;
          if(pressure <= 30.4 && pressure >= 30.0)
            pressure_score = 100;
          else if(pressure <= 30.5 && pressure > 30.4)
            pressure_score = 75 + (30.5 - pressure)*250;
          else if(pressure >= 29.6 && pressure < 30.0)
            pressure_score = 75 + (pressure - 29.6)*62.5;
          //var temp_score = -15.0*temp/8.0 + 625.0/4.0;
          var temp_score = 100 * (temp / 90.0);
          if(temp_score > 100) temp_score = 100;
          
          var cloud_score = 100.0 - cloud;
          var total_score = Math.round((temp_score + pressure_score + wind_score + cloud_score)*100/400);

          var moon = getMoonPhase(date);

          var out_string = "";
          if(total_score > 75)
            out_string = '<span class="badge badge-success">' + total_score + '</span>';
          else if(total_score > 50)
            out_string = '<span class="badge badge-warning">' + total_score + '</span>';
          else if(total_score > 25)
            out_string = '<span class="badge badge-danger">' + total_score + '</span>';
          else
            out_string = '<span class="badge badge-secondary">' + total_score + '</span>';

          $('#current-conditions').remove();

          var current = '<div class="card mt-1"><div class="card-body"><h4 class="card-title" id="current-temp">' + data.name + ' Conditions ' + out_string + '</h4><p class="card-text" id="current-weather">Temperature: ' + temp + "°F<br>Pressure: " + pressure + " inHg<br>Wind: " + wind + "mph<br>Cloud Cover: " + cloud + "%<br>" + moon + '</p></div></div>';

          $("<div/>", {
              "class":"container-fluid",
              "id":"current-conditions",
              html: current
            }).appendTo("main");

        });

        // forecast data
        var url = "https://api.openweathermap.org/data/2.5/forecast?zip=" + $('#zip-code').val() + "&appid=c2abeae755e331ef388663568b1d5ae1&units=imperial";
        
        $.getJSON(url, function(data) {
            var items = [];
            $.each(data.list, function(key, val) {
              var date = new Date(val.dt*1000);
              var wind = val.wind.speed;
              var pressure = Math.round((val.main.pressure)*0.02953*100)/100;
              var temp = val.main.temp;
              var cloud = val.clouds.all;
   
              var wind_score = wind *100 / 10;
          if(wind_score > 100)
            wind_score = 100;
          
          var pressure_score = 0;
          if(pressure <= 30.4 && pressure >= 30.0)
            pressure_score = 100;
          else if(pressure <= 30.5 && pressure > 30.4)
            pressure_score = 75 + (30.5 - pressure)*250;
          else if(pressure >= 29.6 && pressure < 30.0)
            pressure_score = 75 + (pressure - 29.6)*62.5;
          //var temp_score = -15.0*temp/8.0 + 625.0/4.0;
          var temp_score = 100 * (90 - temp) / 50;
          if(temp_score > 100) temp_score = 100;
          
          var cloud_score = 100.0 - cloud;
          var total_score = Math.round((temp_score + pressure_score + wind_score + cloud_score)*100/400);
              var moon = getMoonPhase(date);

              var weather_data = val.main.temp + "°F, " + Math.round((val.main.pressure)*0.02953*100)/100 + " inHg, " + val.wind.speed + "mph, " + val.clouds.all + "% cloud cover, " + moon;

              
              if(total_score > 100) total_score = 100;
              if(total_score < 0) total_score= 0;

              var out_string = "";
              if(total_score >= 75)
                out_string = '<span class="badge badge-success">' + total_score + '</span>';
              else if(total_score >= 50)
                out_string = '<span class="badge badge-warning">' + total_score + '</span>';
              else if(total_score >= 25)
                out_string = '<span class="badge badge-danger">' + total_score + '</span>';
              else
                out_string = '<span class="badge badge-secondary">' + total_score + '</span>';

              items.push('<div class="card mt-1"><div class="card-body"><h5 class="card-title">' + date.toLocaleString() + ": " + out_string + '</h5><p class="card-text">' + weather_data + '</p></div></div>');
            });

            $('#results').remove();

            $("<div/>", {
              "class":"container-fluid",
              "id":"results",
              html: items.join("")
            }).appendTo("main");

        });
      });
    </script>
  </body>
</html>
